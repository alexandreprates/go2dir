pushd . > /dev/null
cd $HOME

json_data="$(curl -s -L -H 'Accept: application/json' https://github.com/alexandreprates/go2dir/releases/latest)"
last_version=$(echo "$json_data" | cut -d \" -f 6)

curl -s -L "https://github.com/alexandreprates/go2dir/archive/$last_version.tar.gz" -o go2dir.tar.gz
tar -zxf "go2dir.tar.gz"

[ -d .go2dir ] && rm -rf .go2dir

mv "go2dir-$last_version" .go2dir
rm go2dir.tar.gz

[[ -s "$HOME/.bashrc" ]] && echo '[[ -s "$HOME/.go2dir/go2dir.sh" ]] && source "$HOME/.go2dir/go2dir.sh"' >> $HOME/.bashrc
[[ -s "$HOME/.zshrc" ]]  && echo '[[ -s "$HOME/.go2dir/go2dir.sh" ]] && source "$HOME/.go2dir/go2dir.sh"' >> $HOME/.zshrc

popd > /dev/null

## migration to named directories
FILENAME="$HOME/.local/share/go2dir/locations.txt"
if [ -e $FILENAME ] && [ "$last_version" \> "2.1.3" ]; then
  cat $FILENAME | while read line; do
    if [[ ! $line =~ (^.*)\|(.*$) ]]; then
        NEWLINE="$(basename $line)|$line"
        sed -i "s,$line,$NEWLINE," "$FILENAME"
    fi
  done
fi

source $HOME/.go2dir/go2dir.sh

echo -e "Done!\n\ntry go2 -h to get some help"
